<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.korit.running_back_s2.domain.crew.CrewMapper">

    <resultMap id="CrewMap" type="com.korit.running_back_s2.domain.crew.Crew">
        <id property="crewId"                   column="crew_id"/>
        <result property="gunguId"              column="gungu_id"/>
        <result property="crewName"             column="crew_name"/>
        <result property="title"                column="title"/>
        <result property="content"              column="content"/>
        <result property="limitedPeople"        column="limited_people"/>
        <result property="profilePicture"       column="profile_picture"/>
        <result property="thumbnailPicture"     column="thumbnail_picture"/>
        <result property="userId"               column="user_id"/>
        <result property="createdAt"            column="created_at"/>
        <result property="totalKm"              column="total_km"/>
        <result property="gunguName"            column="gungu_name"/>
    </resultMap>

    <resultMap id="GungguMap" type="com.korit.running_back_s2.domain.gungu.Gungu">
        <id property="gunguId"                  column="gungu_id"/>
        <result property="gunguName"            column="gungu_name"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="crewId">
        INSERT INTO crew_tb
                ( user_id, gungu_id, crew_name, title, content, limited_people, profile_picture, thumbnail_picture)
        VALUES ( #{userId}, #{gunguId}, #{crewName}, #{title}, #{content}, #{limitedPeople}, #{profilePicture}, #{thumbnailPicture} )
    </insert>

    <select id="findByCrewName" resultType="com.korit.running_back_s2.domain.crew.Crew">
        select
            crew_id,
            gungu_id,
            profile_picture,
            thumbnail_picture,
            crew_name,
            user_id,
            title,
            content,
            limited_people,
            created_at,
            total_km
        from
            crew_tb
        where
            crew_name = #{crewName}
    </select>

    <select id="findByCrewId" resultMap="CrewMap">
        SELECT
            ct.crew_id AS crew_id,
            ct.gungu_id AS gungu_id,
            gt.gungu_name AS gungu_name,
            ct.crew_name as crew_name,
            ct.title as title,
            ct.content as content,
            ct.profile_picture as profile_picture,
            ct.thumbnail_picture as thumbnail_picture,
            ct.limited_people as limited_people,
            ct.user_id AS user_id,
            ct.created_at AS created_at,
            ct.total_km AS total_km
        FROM
            crew_tb ct
            left outer join gungu_tb gt on(ct.gungu_id = gt.gungu_id)
        WHERE
            ct.crew_id = #{crewId}
    </select>
    <select id="findAllBySearchOption" resultMap="CrewMap">
        select
            ct.crew_id as crew_id,
            ct.gungu_id as gungu_id ,
            gt.gungu_name as gungu_name,
            ct.profile_picture as profile_picture,
            ct.thumbnail_picture as thumbnail_picture,
            ct.crew_name as crew_name,
            ct.user_id as user_id,
            ct.title as title,
            ct.content as content,
            ct.created_at as created_at
        from
            crew_tb ct
            left outer join gungu_tb gt on(ct.gungu_id = gt.gungu_id)
        <where>
            <if test="gunguId != null">
                and ct.gungu_id = #{gunguId}
            </if>
            <if test="searchText != null and searchText != ''">
                and (
                crew_name LIKE CONCAT('%', #{searchText}, '%')
                )
            </if>
        </where>
        ORDER BY ct.created_at DESC
        LIMIT #{size} OFFSET #{startIndex}
    </select>

    <select id="countBySearchOption" resultType="int">
        select COUNT(*)
        from crew_tb
        <where>
            <if test="gunguId != null">
                and gungu_id = #{gunguId}
            </if>
            <if test="searchText != null and searchText != ''">
                and (
                crew_name LIKE CONCAT('%', #{searchText}, '%')
                )
            </if>
        </where>
    </select>

    <select id="checkCrew" resultType="java.lang.Integer">
        select
            count(*)
        from
            member_tb
        where
            user_id = #{userId} and role_id = 1
    </select>

    <select id="selectTop10CrewRankingByTotalKm" resultType="com.korit.running_back_s2.dto.ranking.CrewRankingRespDto">
        select
            ct.crew_id,
            ct.crew_name,
            ct.gungu_id,
            gt.gungu_name,
            ct.profile_picture,
            ct.thumbnail_picture,
            ct.total_km,
            coalesce(mt.member_count, 0) as memberCount,
            ct.created_at
        from
            crew_tb ct
            left outer join gungu_tb gt on (ct.gungu_id = gt.gungu_id)
            left outer join (
                        select
                            crew_id,
                            count(*) as member_count
                        from
                            member_tb
                        group by
                            crew_id
                        ) mt on (ct.crew_id = mt.crew_id)
        order by
            ct.total_km desc
        limit 10
    </select>

    <select id="selectTop10CrewRankingByMemberCount" resultType="com.korit.running_back_s2.dto.ranking.CrewRankingRespDto">
        select
            ct.crew_id,
            ct.crew_name,
            ct.gungu_id,
            gt.gungu_name,
            ct.profile_picture,
            ct.thumbnail_picture,
            ct.total_km,
            coalesce(mt.member_count, 0) as memberCount,
            ct.created_at
        from
            crew_tb ct
            left outer join gungu_tb gt on (ct.gungu_id = gt.gungu_id)
            left outer join (
                        select
                            crew_id,
                            count(*) as member_count
                        from
                            member_tb
                        group by
                            crew_id
                        ) mt on (ct.crew_id = mt.crew_id)
        order by
            mt.member_count desc
        limit 10
    </select>

    <select id="selectTop10CrewRankingByCreatedDate" resultType="com.korit.running_back_s2.dto.ranking.CrewRankingRespDto">
        select
            ct.crew_id,
            ct.crew_name,
            ct.gungu_id,
            gt.gungu_name,
            ct.profile_picture,
            ct.thumbnail_picture,
            ct.total_km,
            coalesce(mt.member_count, 0) as memberCount,
            ct.created_at
        from
            crew_tb ct
            left outer join gungu_tb gt on (ct.gungu_id = gt.gungu_id)
            left outer join (
                        select
                            crew_id,
                            count(*) as member_count
                        from
                            member_tb
                        group by
                            crew_id
                        ) mt on (ct.crew_id = mt.crew_id)
        order by ct.created_at desc
        limit 10
    </select>
</mapper>