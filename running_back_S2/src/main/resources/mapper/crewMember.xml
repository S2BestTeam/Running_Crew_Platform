<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.korit.running_back_s2.domain.crew.member.CrewMemberMapper">

    <resultMap id="CrewMemberMap"
               type="com.korit.running_back_s2.domain.crew.member.CrewMember">
        <id     property="crewMemberId" column="crew_member_id"/>
        <result property="userId"       column="cm_user_id"/>
        <result property="roleId"       column="role_id"/>
        <association property="user" resultMap="UserMap" />
    </resultMap>

    <resultMap id="UserMap" type="User" >
        <id property="userId" column="user_id" />
        <result property="oauthType" column="oauth_type" />
        <result property="providerId" column="provider_id" />
        <result property="email" column="email" />
        <result property="picture" column="picture" />
        <result property="fullName" column="full_name" />
        <result property="nickname" column="nickname" />
        <result property="phoneNumber" column="phone_number" />
        <result property="gunguId" column="gungu_id" />
        <result property="address" column="address" />
        <result property="birthDate" column="birth_date" />
        <result property="gender" column="gender" />
        <result property="totalKM" column="total_km" />
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="crewMemberId">
        insert into crew_member_tb (crew_id, user_id, role_id)
        values ( #{crewId}, #{userId}, 4)
    </insert>

    <select id="findAllMembersBySearchOption"
            parameterType="com.korit.running_back_s2.domain.crew.member.CrewMemberSearchOption"
            resultMap="CrewMemberMap">
        select
            cm.crew_member_id,
            cm.user_id as cm_user_id,
            cm.role_id,
            u.full_name,
            u.nickname,
            convert_url('${serverHost}', '/image/profile/', u.picture) as picture
        from
            crew_member_tb cm
            left outer join user_tb u on (u.user_id = cm.user_id)
        where
            cm.crew_id = #{crewId}
            <if test="searchText != null and searchText != ''">
                AND (
                u.full_name LIKE CONCAT('%', #{searchText}, '%')
                OR u.nickname LIKE CONCAT('%', #{searchText}, '%')
                )
            </if>
        order by
            cm.role_id asc,
            cm.crew_member_id asc
        limit #{startIndex}, #{size}
    </select>

    <select id="countMembersBySearchOption"
            parameterType="com.korit.running_back_s2.domain.crew.member.CrewMemberSearchOption"
            resultType="int">
        select
            COUNT(*)
        from
            crew_member_tb cm
            left outer join user_tb u on (u.user_id = cm.user_id)
        where
            cm.crew_id = #{crewId}
            <if test="searchText != null and searchText != ''">
                AND (
                u.full_name LIKE CONCAT('%', #{searchText}, '%')
                OR u.nickname LIKE CONCAT('%', #{searchText}, '%')
                )
            </if>
    </select>
    <select id="findById" resultMap="CrewMemberMap">
        select
            cm.crew_member_id,
            cm.crew_id,
            cm.user_id as cm_user_id,
            cm.role_id,
            u.user_id,
            u.nickname,
            u.full_name,
            convert_url('${serverHost}', '/image/profile/', u.picture) as picture,
            u.gender,
            u.birth_date,
            u.total_km
        from
            crew_member_tb cm
            left outer join user_tb u ON u.user_id = cm.user_id
        where
            cm.crew_member_id = #{memberId}
    </select>

    <update id="updateRole">
        update crew_member_tb
        set
            role_id = #{roleId}
        where
            crew_member_id = #{memberId}
    </update>

    <delete id="deleteMember">
        delete from crew_member_tb
        where member_id = #{memberId}
    </delete>


    <insert id="report" parameterType="com.korit.running_back_s2.domain.crew.member.Report">
        insert into report_tb
        (crew_id, reporter_id, reported_id, reason)
        values
        (#{crewId}, #{reporterId}, #{reportedId}, #{reason});
    </insert>

    <insert id="insertLeaderRole">
        insert into crew_member_tb (crew_id, user_id, role_id)
        values (#{crewId}, #{userId}, 2)
    </insert>
</mapper>
