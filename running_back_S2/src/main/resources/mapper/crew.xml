<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.korit.running_back_s2.domain.crew.CrewMapper">
    <resultMap id="CrewMap" type="com.korit.running_back_s2.domain.crew.Crew">
        <id property="crewId" column="crew_id" />
        <result property="gunguId" column="ct_gungu_id" />
        <result property="crewName" column="crew_name" />
        <result property="crewDescription" column="crew_description" />
        <result property="crewImgPath" column="crew_img_path" />
        <result property="userId" column="ct_user_id" />
        <association property="gungu" resultMap="GungguMap" />
        <association property="user" resultMap="UserMap" />
    </resultMap>

    <resultMap id="GungguMap" type="com.korit.running_back_s2.domain.gungu.Gungu">
        <id property="gunguId" column="gungu_id" />
        <result property="gunguName" column="gungu_name" />
    </resultMap>

    <resultMap id="UserMap" type="com.korit.running_back_s2.domain.user.User">
        <id property="userId" column="user_id" />
        <result property="email" column="email" />
        <result property="fullName" column="full_name" />
        <result property="phoneNumber" column="phone_number" />
        <result property="nickname" column="nickname" />
        <result property="birthDate" column="birth_date" />
        <result property="gender" column="gender" />
        <result property="profileImg" column="profile_img" />
        <result property="gunguId" column="ut_gungu_id" />
    </resultMap>

    <select id="findAllBySearchOption" resultMap="CrewMap" parameterType="com.korit.running_back_s2.domain.crew.CrewSearchOption">
        SELECT
            ct.crew_id,
            ct.gungu_id AS ct_gungu_id,
            ct.crew_name,
            ct.crew_description,
            ct.crew_img_path,
            ct.user_id AS ct_user_id,
            ct.created_at,

            gt.gungu_id,
            gt.gungu_name,

            ut.user_id,
            ut.email,
            ut.full_name,
            ut.phone_number,
            ut.nickname,
            ut.birth_date,
            ut.gender,
            ut.profile_img,
            ut.gungu_id AS ut_gungu_id
        FROM
            crew_tb ct
            LEFT OUTER JOIN gungu_tb gt ON gt.gungu_id = ct.gungu_id
            LEFT OUTER JOIN user_tb ut ON ut.user_id = ct.user_id
        WHERE
            ct.crew_name LIKE CONCAT('%', #{searchText}, '%')
            <if test="gunguId != null and gunguId != -1">
                AND ct.gungu_id = #{gunguId}
            </if>
        ORDER BY ct.crew_id DESC
        LIMIT #{startIndex}, #{size}
    </select>

    <select id="getCountOfOptions" resultType="int">
        SELECT
            COUNT(*)
        FROM
            crew_tb ct
        WHERE
            ct.crew_name LIKE CONCAT('%', #{searchText}, '%')
            <if test="gunguId != null and gunguId != -1">
                AND ct.gungu_id = #{gunguId}
            </if>
    </select>

    <select id="findByCrewId" resultType="com.korit.running_back_s2.domain.crew.Crew">
        SELECT
            ct.crew_id,
            ct.gungu_id AS ct_gungu_id,
            ct.crew_name,
            ct.crew_description,
            ct.crew_img_path,
            ct.user_id AS ct_user_id,
            ct.created_at,

            gt.gungu_id,
            gt.gungu_name,

            ut.user_id,
            ut.email,
            ut.full_name,
            ut.phone_number,
            ut.nickname,
            ut.birth_date,
            ut.gender,
            ut.profile_img,
            ut.gungu_id AS ut_gungu_id
        FROM
            crew_tb ct
            LEFT OUTER JOIN gungu_tb gt ON gt.gungu_id = ct.gungu_id
            LEFT OUTER JOIN user_tb ut ON ut.user_id = ct.user_id
        ORDER BY
            ct.created_at DESC
    </select>

    <insert id="insert" parameterType="com.korit.running_back_s2.domain.crew.Crew" useGeneratedKeys="true" keyProperty="crewId">
        INSERT INTO crew_tb ( user_id, gungu_id, crew_name, crew_description, crew_img_path )
        VALUES ( #{userId}, #{gunguId}, #{crewName}, #{crewDescription}, #{crewImgPath} )
    </insert>

    <select id="findByCrewName" resultType="com.korit.running_back_s2.domain.crew.Crew">
        select
            *
        from
            crew_tb
        where
            crew_name = #{crewName}
    </select>
</mapper>