<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.korit.running_back_s2.domain.crew.CrewMapper">

    <resultMap id="CrewMap" type="com.korit.running_back_s2.domain.crew.Crew">
        <id property="crewId" column="crew_id"/>
        <result property="gunguId" column="gungu_id"/>
        <result property="crewName" column="crew_name"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="limitedPeople" column="limited_people"/>
        <result property="crewProfileImg" column="crew_profile_img"/>
        <result property="crewThumbnailImg" column="crew_thumbnail_img"/>
        <result property="userId" column="user_id"/>
        <result property="createdAt" column="created_at"/>
        <result property="crewTotalKm" column="crew_total_km"/>
        <result property="gunguName" column="gungu_name"/>
    </resultMap>

    <resultMap id="GungguMap" type="com.korit.running_back_s2.domain.gungu.Gungu">
        <id property="gunguId" column="gungu_id"/>
        <result property="gunguName" column="gungu_name"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="crewId">
        INSERT INTO crew_tb ( user_id, gungu_id, crew_name, title, content, limited_people, crew_profile_img ,
        crew_thumbnail_img)
        VALUES ( #{userId}, #{gunguId}, #{crewName}, #{title}, #{content}, #{limitedPeople}, #{crewProfileImg},
        #{crewThumbnailImg} )
    </insert>

    <select id="findByCrewName" resultType="com.korit.running_back_s2.domain.crew.Crew">
        select
            *
        from
            crew_tb
        where
            crew_name = #{crewName}
    </select>

    <select id="findByCrewId" resultMap="CrewMap">
        SELECT
        ct.crew_id AS crew_id,
        ct.gungu_id AS gungu_id,
        gt.gungu_name AS gungu_name,
        ct.crew_name as crew_name,
        ct.title as title,
        ct.content as content,
        ct.crew_profile_img as crew_profile_img,
        ct.crew_thumbnail_img as crew_thumbnail_img,
        ct.limited_people as limited_people,
        ct.user_id AS user_id,
        ct.created_at AS created_at,
        ct.crew_total_km AS crew_total_km
        FROM
        crew_tb ct
        left outer join gungu_tb gt on(ct.gungu_id = gt.gungu_id)
        WHERE
        ct.crew_id = #{crewId}
    </select>
    <select id="findAllBySearchOption" resultMap="CrewMap">
        select
        ct.crew_id as crew_id,
        ct.gungu_id as gungu_id ,
        gt.gungu_name as gungu_name,
        ct.crew_profile_img as crew_profile_img,
        ct.crew_thumbnail_img as crew_thumbnail_img,
        ct.crew_name as crew_name,
        ct.user_id as user_id,
        ct.title as title,
        ct.content as content,
        ct.created_at as created_at
        from
        crew_tb ct
        left outer join gungu_tb gt on(ct.gungu_id = gt.gungu_id)
        <where>
            <if test="gunguId != null">
                and ct.gungu_id = #{gunguId}
            </if>
            <if test="searchText != null and searchText != ''">
                and (
                crew_name LIKE CONCAT('%', #{searchText}, '%')
                OR title LIKE CONCAT('%', #{searchText}, '%')
                OR content LIKE CONCAT('%', #{searchText}, '%')
                )
            </if>
        </where>
        ORDER BY ct.created_at DESC
        LIMIT #{size} OFFSET #{startIndex}
    </select>

    <select id="countBySearchOption" resultType="int">
        select COUNT(*)
        from crew_tb
        <where>
            <if test="gunguId != null">
                and gungu_id = #{gunguId}
            </if>
            <if test="searchText != null and searchText != ''">
                and (
                crew_name LIKE CONCAT('%', #{searchText}, '%')
                OR title LIKE CONCAT('%', #{searchText}, '%')
                OR content LIKE CONCAT('%', #{searchText}, '%')
                )
            </if>
        </where>
    </select>


</mapper>