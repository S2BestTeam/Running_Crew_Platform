<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.korit.running_back_s2.domain.gathering.GatheringMapper">
    <resultMap id="GatheringMap" type="Gathering">
        <id property="gatheringId" column="gathering_id" />
        <result property="crewId" column="crew_id" />
        <result property="userId" column="cgt_user_id" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="thumbnailPicture" column="thumbnail_picture" />
        <result property="runningDate" column="running_date" />
        <result property="runningTime" column="running_time" />
        <result property="placeName" column="place_name" />
        <result property="address" column="address" />
        <result property="roadAddress" column="road_address" />
        <result property="latitude" column="latitude" />
        <result property="longitude" column="longitude" />
        <result property="km" column="km" />
        <result property="cost" column="cost" />
        <result property="maxParticipants" column="max_participants" />
        <result property="status" column="status" />
        <result property="createdAt" column="created_at" />
        <association property="user" resultMap="UserMap" />
    </resultMap>

    <resultMap id="UserMap" type="User">
        <id property="userId" column="user_id" />
        <result property="nickname" column="nickname" />
        <result property="fullName" column="full_name" />
        <result property="picture" column="picture" />
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="gatheringId">
        INSERT INTO gathering_tb
        VALUES (
            default,
            #{crewId},
            #{userId},
            #{title},
            #{content},
            #{thumbnailPicture},
            #{runningDate},
            #{runningTime},
            #{placeName},
            #{address},
            #{roadAddress},
            #{latitude},
            #{longitude},
            #{km},
            #{cost},
            #{maxParticipants},
            1,
            now()
        );
    </insert>

    <select id="findAllByCrewId" resultType="com.korit.running_back_s2.dto.gathering.GatheringRespDto">
        SELECT
            cgt.gathering_id,
            cgt.crew_id,
            cgt.user_id as cgt_user_id,
            cgt.title,
            cgt.content,
            thumbnail_picture as thumbnail_picture,
            cgt.running_date,
            cgt.running_time,
            cgt.place_name,
            cgt.address,
            cgt.road_address,
            cgt.latitude,
            cgt.longitude,
            cgt.km,
            cgt.cost,
            cgt.max_participants,

            ut.user_id,
            ut.nickname,
            ut.full_name,
            ut.picture as picture
        FROM
            gathering_tb cgt
            left outer join user_tb ut on (ut.user_id = cgt.user_id)
        WHERE
            cgt.crew_id = #{crewId}
        ORDER BY
            running_date DESC, running_time DESC
    </select>

</mapper>
